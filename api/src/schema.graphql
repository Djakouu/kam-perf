scalar Date

type Query {
  # Fetch the full hierarchy for the dashboard
  # Can filter by date range, country, TAM, etc.
  getHierarchy(filters: FilterInput): [Account!]!

  # Fetch history for charts
  getHistory(
    entityId: ID!
    entityType: EntityType!
    tool: ToolType!
    dateRange: DateRangeInput
  ): [HistoryPoint!]!

  # Check job status
  getJobStatus(jobId: ID!): JobProgress

  # Scheduler Metrics
  getSchedulerMetrics: SchedulerMetrics

  # Analytics
  getAnalytics(filters: FilterInput): AnalyticsResult!
}

type SchedulerMetrics {
  waiting: Int
  active: Int
  completed: Int
  failed: Int
  delayed: Int
  paused: Int
}

type AnalyticsResult {
  summary: [AnalyticsSummaryRow!]!
  trends: [AnalyticsTrendSeries!]!
}

type AnalyticsSummaryRow {
  id: ID! # "ALL" or TAM name
  label: String! # "All TAMs" or TAM Name
  totalAccounts: Int!
  totalDomains: Int!
  totalPages: Int!
  domainsWith5PlusPages: Int!
  domainsByCpu: CpuDistribution!
}

type CpuDistribution {
  under500: Int!
  between500And1000: Int!
  between1000And2000: Int!
  over2000: Int!
}

type AnalyticsTrendSeries {
  id: ID! # "ALL" or TAM name
  label: String!
  data: [AnalyticsTrendPoint!]!
}

type AnalyticsTrendPoint {
  date: Date!
  totalAccounts: Int!
  totalDomains: Int!
  totalPages: Int!
  domainsWith5PlusPages: Int!
  domainsByCpu: CpuDistribution!
}

type Mutation {
  # Account CRUD
  createAccount(input: CreateAccountInput!): Account!
  updateAccount(id: ID!, input: UpdateAccountInput!): Account!
  deleteAccount(id: ID!): Boolean!

  # Domain CRUD
  createDomain(input: CreateDomainInput!): Domain!
  updateDomain(id: ID!, input: UpdateDomainInput!): Domain!
  deleteDomain(id: ID!): Boolean!

  # Page CRUD
  createPage(input: CreatePageInput!): Page!
  updatePage(id: ID!, input: UpdatePageInput!): Page!
  deletePage(id: ID!): Boolean!

  # Analysis
  triggerAnalysis(pageId: ID!, tool: ToolType!): JobStatus!
  cancelAnalysis(jobId: ID!): Boolean!

  # Comments
  addComment(input: AddCommentInput!): Comment!
  deleteComment(id: ID!): Boolean!
}

# --- Types ---

type Account {
  id: ID!
  name: String!
  country: String!
  tamName: String
  domains: [Domain!]!
  
  # Aggregated stats for the dashboard view (latest available day)
  stats(tool: ToolType!): AggregatedStats
}

type Domain {
  id: ID!
  name: String!
  sitecode: String
  selfHostingUrl: String
  cookieConsentCode: String
  consentStrategy: String
  pages: [Page!]!
  
  # Aggregated stats
  stats(tool: ToolType!): AggregatedStats
}

type Page {
  id: ID!
  url: String!
  sitecode: String
  
  # Latest stats
  stats(tool: ToolType!): AggregatedStats
}

type AggregatedStats {
  date: Date!
  desktopCpuAvg: Float!
  mobileCpuAvg: Float!
}

type HistoryPoint {
  date: Date!
  desktopCpuAvg: Float!
  mobileCpuAvg: Float!
  comment: Comment
}

type Comment {
  id: ID!
  text: String!
  date: Date!
}

type JobStatus {
  jobId: ID!
  status: String! # queued, processing
}

type JobProgress {
  jobId: ID!
  status: String!
  progress: Int!
  failedReason: String
  message: String
}

# --- Inputs ---

input FilterInput {
  dateRange: DateRangeInput
  country: String
  tamName: String
  sitecode: String
  minCpu: Float
  maxCpu: Float
  device: String
}

input DateRangeInput {
  start: Date!
  end: Date!
}

input CreateAccountInput {
  name: String!
  country: String!
  tamName: String
}

input UpdateAccountInput {
  name: String
  country: String
  tamName: String
}

input CreateDomainInput {
  accountId: ID!
  name: String!
  sitecode: String
  selfHostingUrl: String
  cookieConsentCode: String
  consentStrategy: String
}

input UpdateDomainInput {
  name: String
  sitecode: String
  selfHostingUrl: String
  cookieConsentCode: String
  consentStrategy: String
}

input CreatePageInput {
  domainId: ID!
  url: String!
  sitecode: String
}

input UpdatePageInput {
  url: String
  sitecode: String
}

input AddCommentInput {
  entityId: ID!
  entityType: EntityType!
  date: Date!
  text: String!
}

enum EntityType {
  ACCOUNT
  DOMAIN
  PAGE
}

enum ToolType {
  KAMELEOON
}
